---
import PageLayout from '../../layouts/BaseLayout.astro'
---

<PageLayout meta={{ title: 'A/B Test Simulator' }}>
	<div class="w-full space-y-8">
		<!-- Memorize Overlay -->
		<div
			id="memorize-message"
			data-visible="false"
			class="memorize-overlay"
			role="dialog"
			aria-live="assertive"
		>
			<div class="memorize-overlay-card">
				<div class="text-sm uppercase tracking-[0.4em] text-muted-foreground">Memorize Fast</div>
				<h2 class="text-2xl font-semibold text-foreground">üß† Memorize the Pineapples</h2>
				<p class="text-sm text-muted-foreground">You have five seconds before the board hides every üçç.</p>
				<div class="pt-4">
					<div class="text-xs font-semibold uppercase tracking-[0.3em] text-red-500">Hiding In</div>
					<div id="countdown-number" class="text-6xl font-black text-red-600 tabular-nums">5</div>
				</div>
			</div>
		</div>

		<!-- Header -->
		<div class="space-y-2">
			<h1 class="text-3xl font-bold">A/B Test Simulator</h1>
			<p class="text-base text-muted-foreground">Interactive memory game puzzle demonstrating A/B testing with PostHog experiments and real-time analytics. 
				<br />I built this from scratch using a full analytics stack with Astro front‚Äëend ‚Üí Supabase PostgREST (SQL views/RPCs) ‚Üí PostHog events ‚Üí Supabase Webhooks ‚Üí Plotly charts on Astro. My goal is to show not just what experimentation means from a statistical POV, but also from a tech implementation and user experience POV. 
			</p>
		</div>

		<!-- Challenge Info -->
		<div id="challenge-section" class="rounded-lg border bg-card p-4">
			<h3 class="mb-3 font-semibold">Your Challenge</h3>
			<div class="grid grid-cols-2 gap-3 md:grid-cols-4">
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Variant</div>
					<div id="user-variant" class="font-mono font-bold">Loading...</div>
				</div>
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Your Random Username</div>
					<div id="user-username" class="truncate font-mono">Loading...</div>
				</div>
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Difficulty</div>
					<div id="difficulty-display" class="font-mono">Loading...</div>
				</div>
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">No. of Pineapples to Find</div>
					<div id="target-word-count" class="font-mono font-bold">0</div>
				</div>
			</div>
		</div>

		<!-- Puzzle Section -->
		<div id="puzzle-section" class="space-y-4 rounded-2xl border bg-card/95 p-4">
			<h3 class="font-semibold">Find the PINPEAPPLES üçç</h3>
			
			<!-- Three-column layout: Grid (1/3) + Controls (1/3) + Stats (1/3) -->
			<div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
				<!-- LEFT: Letter Grid (1/3) -->
				<div>
					<div id="letter-grid" class="grid grid-cols-5 gap-4 max-w-[300px] rounded-2xl border-2 border-transparent p-2 transition-all duration-300"></div>
				</div>

				<!-- CENTER: Controls & Info (1/3) -->
				<div class="space-y-4">
					<!-- Timer + Try Again Button (always visible, changes state) -->
					<div class="flex flex-col gap-1">
						<!-- Action Button (Start / Try Again / Reset) -->
						<div id="controls" class="flex flex-row gap-2">
							<button id="start-button" class="flex-1 rounded-lg bg-primary px-3 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors">Start</button>
							<button id="reset-button" class="hidden flex-1 rounded-lg bg-orange-500 px-3 py-2 text-sm font-medium text-white transition-colors hover:bg-orange-600">Stop</button>
							<button class="try-again-button hidden flex-1 rounded-lg bg-orange-600 px-3 py-2 text-sm font-medium text-white hover:bg-orange-700 transition-colors">Try Again</button>
						</div>
						
						<!-- Timer -->
						<div class="grid grid-cols-3 items-center rounded-lg bg-muted p-4">
							<div class="text-xs text-muted-foreground">Time</div>
							<div id="timer" class="font-mono text-2xl font-bold col-span-2">00:60:00</div>
						</div>
					</div>

					<!-- Pineapples Found -->
					<div id="found-pineapples" class="rounded-lg bg-muted p-3">
						<div class="text-xs text-muted-foreground mb-2">Pineapples Found</div>
						<div id="found-pineapples-list" class="font-mono text-sm">0</div>
					</div>
				</div>

				<!-- RIGHT: Leaderboard (1/3) -->
				<div id="leaderboard-display" class="rounded-2xl border border-border/60 bg-muted/70 p-3 shadow-sm">
					<div class="flex items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.2em] text-muted-foreground">
						<span class="text-base">üèÜ</span>
						<span>Top Players</span>
					</div>
					<div id="leaderboard-list" class="mt-3 text-xs"></div>
				</div>
			</div>
		</div>

		<!-- Result Card (modular, single-line design) -->
		<div id="result-card" class="hidden rounded-2xl border border-green-200 bg-green-50 p-4 dark:border-green-900 dark:bg-green-950">
			<div class="flex flex-wrap items-center justify-between gap-4">
				<!-- Left: Status Badge -->
				<div class="flex flex-col gap-2">
					<div class="inline-flex items-center gap-3 px-3 py-2 rounded-xl bg-white dark:bg-slate-950 border border-green-200 dark:border-green-900">
						<span class="text-xl">üéâ</span>
						<div>
							<p class="text-xs font-semibold text-muted-foreground uppercase tracking-wide">Challenge Complete</p>
							<p id="result-message" class="text-sm font-bold">üèÜ Personal Best!</p>
						</div>
					</div>
					<div id="personal-best-pill" class="hidden flex items-center gap-2 rounded-full border border-yellow-300 bg-yellow-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-yellow-700 dark:border-yellow-400/60 dark:bg-yellow-400/10 dark:text-yellow-200">
						<span class="text-base">‚ú®</span>
						<span>New Personal Best</span>
					</div>
				</div>

				<!-- Middle: Stats (Time & Guesses) -->
				<div class="flex items-center gap-4 px-3 py-2 rounded-xl bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800">
					<div class="text-center">
						<p class="text-xs text-muted-foreground">Time</p>
						<p class="font-mono font-bold text-base"><span id="result-time">00:00:00</span></p>
					</div>
					<div class="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
					<div class="text-center">
						<p class="text-xs text-muted-foreground">Guesses</p>
						<p class="font-mono font-bold text-base"><span id="result-guesses">0</span></p>
					</div>
				</div>

				<!-- Right: Actions -->
				<div class="flex gap-2">
					<button class="try-again-button hidden rounded-lg bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-700 transition-colors">Try Again</button>
					<a href="#dashboard-section" class="rounded-lg bg-secondary px-4 py-2 text-sm font-medium text-secondary-foreground hover:bg-secondary/80 transition-colors">View Stats</a>
				</div>
			</div>
		</div>

		<!-- Dashboard -->
		<div id="dashboard-section" class="space-y-6 rounded-lg border bg-card p-4">
			<div class="flex items-center justify-between">
				<div>
					<h3 class="font-semibold">üìä Analytics Dashboard</h3>
					<p class="text-xs text-muted-foreground">Real-time A/B test results</p>
				</div>
				<div class="flex items-center gap-3">
					<button 
						onclick="window.refreshDashboard()" 
						class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
						title="Refresh dashboard data"
					>
						üîÑ Refresh
					</button>
					<div id="update-indicator" class="text-xs text-muted-foreground">
						<span id="last-updated">Loading...</span>
					</div>
				</div>
			</div>

			<!-- Comparison Card (High Priority) -->
			<div class="rounded-xl border bg-card p-6">
				<div class="grid grid-cols-3 gap-6">
					<!-- Variant A -->
					<div class="space-y-3">
						<div class="flex items-center gap-2">
							<div class="flex items-center justify-center w-6 h-6 rounded text-black text-xs font-bold bg-[#f9e9cc]">A</div>
							<div class="text-sm font-semibold">Control (4 pineapples)</div>
						</div>
						<div>
							<div class="text-xs text-muted-foreground">Total Completions</div>
							<div id="variant-a-count" class="text-2xl font-bold">--</div>
						</div>
						<div>
							<div class="text-xs text-muted-foreground">Avg Completion Time</div>
							<div id="variant-a-time" class="font-mono text-2xl font-bold">--</div>
						</div>
					</div>

					<!-- Variant B -->
					<div class="space-y-3">
						<div class="flex items-center gap-2">
							<div class="flex items-center justify-center w-6 h-6 rounded text-black text-xs font-bold bg-[#f5a656]">B</div>
							<div class="text-sm font-semibold">Treatment (5 pineapples)</div>
						</div>
						<div>
							<div class="text-xs text-muted-foreground">Total Completions</div>
							<div id="variant-b-count" class="text-2xl font-bold">--</div>
						</div>
						<div>
							<div class="text-xs text-muted-foreground">Avg Completion Time</div>
							<div id="variant-b-time" class="font-mono text-2xl font-bold">--</div>
						</div>
					</div>

					<!-- Comparison -->
					<div class="space-y-3">
						<div class="flex items-center gap-2">
							<div class="text-xl">‚öñÔ∏è</div>
							<div class="text-sm font-semibold">Comparison</div>
						</div>
						<div>
							<div class="text-xs text-muted-foreground">Time Difference</div>
							<div id="comparison-diff" class="font-mono text-2xl font-bold text-muted-foreground">--%</div>
						</div>
						<div id="comparison-status-box" class="rounded-lg bg-muted p-3">
							<div id="comparison-status" class="text-sm font-medium">--</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Funnel Chart (Moved up) -->
			<div class="rounded-lg border bg-card p-4">
				<div id="funnel-chart"></div>
			</div>

			<!-- Charts Grid: Avg Time + Distribution -->
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<!-- Avg Time Chart -->
				<div class="rounded-lg border bg-card p-4">
					<div id="avg-time-chart"></div>
				</div>

				<!-- Distribution Chart (Histogram) -->
				<div class="rounded-lg border bg-card p-4">
					<div id="distribution-chart"></div>
				</div>
			</div>

			<!-- Recent Completions Table -->
			<div class="rounded-lg border bg-card p-4">
				<h4 class="text-sm font-semibold mb-4">Recent Completions</h4>
				<div id="completions-table"></div>
			</div>
		</div>

		<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" is:inline></script>
		<script src="/js/utils.js" is:inline></script>
		<script src="/js/puzzle-config.js" is:inline></script>
		<!-- Inject Supabase config for PostgREST access (uses public env vars) -->
		<script
			is:inline
			define:vars={{
				SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL,
				SUPABASE_ANON_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY
			}}
		>
			window.__SUPABASE_URL__ = SUPABASE_URL;
			window.__SUPABASE_ANON_KEY__ = SUPABASE_ANON_KEY;
		</script>
		<script src="/js/ab-sim/supabase-api.js" is:inline></script>
		<script src="/js/ab-sim/core.js" is:inline></script>
		<script src="/js/ab-sim/dashboard.js" is:inline></script>
	</div>

</PageLayout>

<script>
import { uniqueNamesGenerator, adjectives, animals } from 'unique-names-generator';

// Export to global window for use by ab-simulator.js
(window as any).generateRandomUsername = function() {
  return uniqueNamesGenerator({
    dictionaries: [adjectives, animals],
    separator: ' ',
    style: 'capital',
    length: 2
  });
};
</script>

<!-- consolidated into /js/ab-sim/core.js -->
